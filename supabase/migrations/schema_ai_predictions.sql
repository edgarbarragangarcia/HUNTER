-- AI Predictive Engine Schema

-- 1. Historical Tenders Cache (for analytics and training)
-- Stores processed SECOP data optimized for analysis
create table if not exists public.historical_tenders (
  id uuid default gen_random_uuid() primary key,
  secop_id text unique not null,
  title text not null,
  description text,
  amount numeric,
  currency text default 'COP',
  status text,
  published_at timestamptz,
  closing_at timestamptz,
  awarded_at timestamptz,
  entity_name text,
  entity_nit text,
  region text,
  department text,
  city text,
  category text,
  unspsc_codes jsonb, -- Array of codes
  winner_nit text, -- NIT of the winner if awarded
  winner_name text,
  competitors_count integer,
  embedding vector(1536), -- For semantic search
  processed_for_ai boolean default false,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create index idx_historical_tenders_secop_id on public.historical_tenders(secop_id);
create index idx_historical_tenders_entity on public.historical_tenders(entity_name);
create index idx_historical_tenders_published on public.historical_tenders(published_at);
create index idx_historical_tenders_category on public.historical_tenders(category);

-- 2. AI Predictions
-- Stores generated predictions for specific tenders/opportunities
create table if not exists public.ai_predictions (
  id uuid default gen_random_uuid() primary key,
  tender_id uuid references public.historical_tenders(id) on delete cascade, -- Can be null if it's a live tender not yet in history
  secop_process_id text, -- Fallback if not in historical_tenders
  prediction_type text not null, -- 'opportunity', 'success_probability', 'risk', 'corruption'
  score numeric, -- 0-100 score
  confidence numeric, -- 0-1 confidence level
  explanation text, -- AI generated explanation
  details jsonb, -- Structured details of the prediction
  model_version text,
  created_at timestamptz default now()
);

create index idx_ai_predictions_tender on public.ai_predictions(tender_id);
create index idx_ai_predictions_type on public.ai_predictions(prediction_type);

-- 3. User Preferences (for Matchmaking)
-- Stores detailed preferences for AI matching beyond basic profile
create table if not exists public.user_ai_preferences (
  id uuid default gen_random_uuid() primary key,
  profile_id uuid references public.profiles(id) on delete cascade not null,
  preferred_sectors jsonb,
  preferred_regions jsonb,
  min_amount numeric,
  max_amount numeric,
  risk_tolerance text default 'medium', -- 'low', 'medium', 'high'
  competitor_avoidance_list jsonb, -- NITs of competitors to avoid
  keywords_positive jsonb,
  keywords_negative jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create index idx_user_ai_preferences_profile on public.user_ai_preferences(profile_id);

-- 4. AI Alerts
-- Stores intelligent alerts generated by the system
create table if not exists public.ai_alerts (
  id uuid default gen_random_uuid() primary key,
  profile_id uuid references public.profiles(id) on delete cascade not null,
  alert_type text not null, -- 'anomaly', 'opportunity', 'risk', 'competitor', 'date'
  priority text default 'medium', -- 'low', 'medium', 'high', 'critical'
  title text not null,
  message text not null,
  related_entity_id text, -- ID of related tender, competitor, etc.
  related_entity_type text, -- 'tender', 'competitor', 'market'
  is_read boolean default false,
  action_required boolean default false,
  metadata jsonb,
  created_at timestamptz default now()
);

create index idx_ai_alerts_profile on public.ai_alerts(profile_id);
create index idx_ai_alerts_unread on public.ai_alerts(profile_id) where is_read = false;

-- 5. Competitor Analysis
-- Stores aggregated data about competitors
create table if not exists public.competitor_analysis (
  id uuid default gen_random_uuid() primary key,
  nit text unique not null,
  name text not null,
  total_contracts integer default 0,
  total_amount numeric default 0,
  win_rate numeric, -- 0-1
  top_sectors jsonb,
  top_entities jsonb,
  risk_score numeric,
  last_analyzed_at timestamptz,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create index idx_competitor_analysis_nit on public.competitor_analysis(nit);

-- 6. Market Metrics (Aggregated)
-- Pre-calculated metrics for fast dashboard loading
create table if not exists public.market_metrics (
  id uuid default gen_random_uuid() primary key,
  metric_type text not null, -- 'sector_growth', 'entity_spending', 'regional_distribution'
  dimension text, -- Specific sector, region, etc.
  period text, -- 'monthly', 'quarterly', 'yearly'
  start_date date,
  end_date date,
  value numeric,
  data jsonb, -- Detailed breakdown
  created_at timestamptz default now()
);

create index idx_market_metrics_type on public.market_metrics(metric_type, dimension);

-- RLS Policies

-- Historical Tenders: Readable by all authenticated users
alter table public.historical_tenders enable row level security;
create policy "Historical tenders viewable by authenticated" on public.historical_tenders
  for select using (auth.uid() is not null);

-- AI Predictions: Readable by all authenticated users (general predictions)
-- Note: If we have personalized predictions, we might need to restrict this
alter table public.ai_predictions enable row level security;
create policy "Predictions viewable by authenticated" on public.ai_predictions
  for select using (auth.uid() is not null);

-- User AI Preferences: Only owner
alter table public.user_ai_preferences enable row level security;
create policy "Users manage own preferences" on public.user_ai_preferences
  for all using (
    exists (
      select 1 from public.profiles
      where profiles.id = user_ai_preferences.profile_id
      and profiles.user_id = auth.uid()
    )
  );

-- AI Alerts: Only owner
alter table public.ai_alerts enable row level security;
create policy "Users manage own alerts" on public.ai_alerts
  for all using (
    exists (
      select 1 from public.profiles
      where profiles.id = ai_alerts.profile_id
      and profiles.user_id = auth.uid()
    )
  );

-- Competitor Analysis: Readable by all authenticated
alter table public.competitor_analysis enable row level security;
create policy "Competitor analysis viewable by authenticated" on public.competitor_analysis
  for select using (auth.uid() is not null);

-- Market Metrics: Readable by all authenticated
alter table public.market_metrics enable row level security;
create policy "Market metrics viewable by authenticated" on public.market_metrics
  for select using (auth.uid() is not null);
